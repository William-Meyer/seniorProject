<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel="stylesheet" href="index.css">
  </head>
  <body id = "body">
    <h1 id="out">Waiting for 2 players...</h1>
    <canvas id="canvas" width="1200" height="675">
      Please use a browser that supports HTML5 Canvas.
    </canvas>
    <img id = "bgImage" src="field2.jpg" alt="">
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
    var socket = io();
    //alert function from server
    socket.on('serverAlert',function(msg){
      alert('Server Alert: ' + msg);
    });

    //game logic below
    class Camera{
      constructor(x,y, xMin, yMin, xMax, yMax){
        this.x =x;
        this.y = y;
        this.width = canvas.width;
        this.height = canvas.height;
        this.xMin = xMin;
        this.yMin = yMin;
        this.xMax = xMax;
        this.yMax = yMax;
      }
      setLoc(x,y){
        this.x = x;
        this.y = y;
        if(this.x<this.xMin){
          this.x = this.xMin;
        }
        if(this.x>this.xMax){
          this.x = this.xMax;
        }
        if(this.y<this.yMin){
          this.y = this.yMin;
        }
        if(this.y>this.yMax){
          this.y = this.yMax;
        }
          //478, 340
          //846, 2928
      }
    }
    class Sprite{
      constructor(x,y,scale,src){
        this.x = x;
        this.y = y;
        this.scale = scale;
        this.src = src;
        this.img = document.createElement("img");
        this.img.src = src;
        //document.getElementById('body').appendChild(this.img);
      }
      drawSprite(ctx){

        ctx.drawImage(this.img, cam.width/2-cam.x+this.x, cam.height/2-cam.y+this.y);
      }
    }
    //--------------------------------------
    //basic set up
    let clientSprites = [];//list to keep track of sprite info on the client end
    //--Setting up canvas
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    //--
    //478, 340
    //846, 2928
    var cam = new Camera(240,240,610,340,846,2928)//init camera at the cords in params
    const scaleConst = 1;
    let keyss = [];
    var bgImg = document.getElementById('bgImage');
    var playerId = 0;
    //--------------------------------------
    function update(){

      //ctx.fillStyle = "blue";
      //ctx.fillRect(0, 0, canvas.width, canvas.height);
      cam.setLoc(clientSprites[0].x,clientSprites[0].y);
      ctx.drawImage(bgImg, cam.width/2-cam.x, cam.height/2-cam.y);
      for( let i = 0; i < clientSprites.length; i++){
        clientSprites[i].drawSprite(ctx);
      }

    }
    socket.on('playerId',function(id){
      playerId = id;
    });
    socket.on('startGame',function(){
      console.log('game starting')
      document.getElementById('out').innerHTML = 'Game has Started';
      socket.emit('move');
      update();
    });
    var keys = [];
    window.addEventListener("keydown",
      function(e){
        keyss[e.keyCode] = true;
    },
    false);

    window.addEventListener('keyup',
      function(e){
        keyss[e.keyCode] = false;
    },
    false);
    socket.on('updateClientSprites',function(list){
      for(let i=0; i<list.length; i++){
        alert('creating Sprites');
        clientSprites.push(new Sprite(list[i].x,list[i].y,scaleConst,list[i].src));
        console.log('client Sprites init: '+clientSprites);
        clientSprites[i].drawSprite(ctx);
        console.log('Ready...')
        socket.emit('ready');
      }
    });
    socket.on('moveSprite',function(index,dX,dY){
      clientSprites[index].x = dX;
      clientSprites[index].y = dY;
      if(index == 0){
        console.log('X: ' + dX);
        console.log('Y: ' + dY);
        console.log(clientSprites[index].x);
        console.log(clientSprites[index].y);
      }
      update();//NOTICE NEEDS TO CHANGE LATER !!RECURSION WARNIN!!
    });
    socket.on('getKeys',function(){
      socket.emit('setKeys',keyss);
    });
    //will be cahnged into update loop

    function start(){
      console.log('game starting')
      document.getElementById('out').innerHTML = 'Game has Started';
      socket.emit('move');
      update();
    }
    </script>
  </body>
</html>
